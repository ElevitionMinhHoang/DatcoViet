generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                  Int           @id @default(autoincrement())
  email               String        @unique
  password            String
  role                Role          @default(USER)
  failedLoginAttempts Int           @default(0)
  isLocked            Boolean       @default(false)
  passwordChangedAt   DateTime?
  passwordChangeCount Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  name                String
  phone               String
  address             String?
  orders              Order[]
  shipperDeliveries   Delivery[]
  chatRooms           ChatRoom[]
  chatMessages        ChatMessage[]
  passwordResetTokens PasswordResetToken[]
}

model Menu {
  id        Int         @id @default(autoincrement())
  name      String
  price     Float
  category  String
  image     String?
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  orders    OrderItem[]
}

model Order {
  id        Int         @id @default(autoincrement())
  userId    Int
  total     Float
  status    OrderStatus @default(PENDING)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User        @relation(fields: [userId], references: [id])
  items     OrderItem[]
  payment   Payment?
  feedback  Feedback?
  delivery  Delivery?
}

model OrderItem {
  id       Int   @id @default(autoincrement())
  orderId  Int
  menuId   Int
  quantity Int
  price    Float
  order    Order @relation(fields: [orderId], references: [id])
  menu     Menu  @relation(fields: [menuId], references: [id])
}

model Payment {
  id        Int           @id @default(autoincrement())
  orderId   Int           @unique
  status    PaymentStatus @default(PENDING)
  amount    Float
  method    String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  order     Order         @relation(fields: [orderId], references: [id])
}

model Feedback {
  id         Int      @id @default(autoincrement())
  orderId    Int      @unique
  rating     Int
  comment    String?
  images     String[] // Store image URLs as JSON array
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  order      Order    @relation(fields: [orderId], references: [id])
}

model Delivery {
  id        Int            @id @default(autoincrement())
  orderId   Int            @unique
  shipperId Int
  status    DeliveryStatus @default(ASSIGNED)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  order     Order          @relation(fields: [orderId], references: [id])
  shipper   User           @relation(fields: [shipperId], references: [id])
}

enum Role {
  ADMIN
  USER
  CSKH
  SHIPPER
  MANAGER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  DELIVERING
  DELIVERED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum DeliveryStatus {
  ASSIGNED
  PICKING_UP
  ON_THE_WAY
  DELIVERED
  FAILED
}

model Contact {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatRoom {
  id        Int       @id @default(autoincrement())
  userId    Int
  status    ChatStatus @default(ACTIVE)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
  messages  ChatMessage[]
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  roomId    Int
  senderId  Int
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  room      ChatRoom @relation(fields: [roomId], references: [id])
  sender    User     @relation(fields: [senderId], references: [id])
}

enum ChatStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}
